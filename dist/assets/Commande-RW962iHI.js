import{c as $,r as s,j as e,M as ie,h as E,m as $e,l as Be,d as S,o as Le}from"./index-DHz37_S4.js";import{U as Ke}from"./upload-B5bgnvYU.js";import{T as Qe}from"./triangle-alert-CQbwQLWo.js";import{C as Ge}from"./circle-plus-Se8zv2co.js";import{D as Je,P as He}from"./plus-BmtIdkoR.js";/**
 * @license lucide-react v0.544.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ve=[["path",{d:"m12 19-7-7 7-7",key:"1l729n"}],["path",{d:"M19 12H5",key:"x3x0zl"}]],We=$("arrow-left",Ve);/**
 * @license lucide-react v0.544.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ye=[["path",{d:"M20 6 9 17l-5-5",key:"1gmf2c"}]],Xe=$("check",Ye);/**
 * @license lucide-react v0.544.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ze=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M8 12h8",key:"1wcyev"}]],et=$("circle-minus",Ze);/**
 * @license lucide-react v0.544.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const tt=[["path",{d:"M22 17a2 2 0 0 1-2 2H6.828a2 2 0 0 0-1.414.586l-2.202 2.202A.71.71 0 0 1 2 21.286V5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2z",key:"18887p"}]],nt=$("message-square",tt);/**
 * @license lucide-react v0.544.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const st=[["path",{d:"M5 12h14",key:"1ays0h"}]],rt=$("minus",st);/**
 * @license lucide-react v0.544.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const at=[["path",{d:"M14.536 21.686a.5.5 0 0 0 .937-.024l6.5-19a.496.496 0 0 0-.635-.635l-19 6.5a.5.5 0 0 0-.024.937l7.93 3.18a2 2 0 0 1 1.112 1.11z",key:"1ffxy3"}],["path",{d:"m21.854 2.147-10.94 10.939",key:"12cjpa"}]],it=$("send",at),lt=({isOpen:a,onClose:l,order:r,onFinalize:u})=>{const[o,m]=s.useState("efectivo"),[j,w]=s.useState(null),[N,c]=s.useState(!1),C=async h=>{h.preventDefault(),o&&(c(!0),await u(o,j),c(!1),l())};return e.jsx(ie,{isOpen:a,onClose:l,title:`Finalizar el pedido #${r.id.slice(-4)}`,children:e.jsxs("form",{onSubmit:C,className:"space-y-6",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-gray-600",children:"Total a pagar"}),e.jsx("p",{className:"text-4xl font-extrabold text-gray-900",children:E(r.total)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Método de pago"}),e.jsxs("select",{value:o,onChange:h=>m(h.target.value),className:"mt-1 ui-select",children:[e.jsx("option",{value:"efectivo",children:"Efectivo"}),e.jsx("option",{value:"transferencia",children:"Transferencia"}),e.jsx("option",{value:"tarjeta",children:"Tarjeta"})]})]}),o==="transferencia"&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Comprobante (opcional)"}),e.jsxs("label",{htmlFor:"payment-receipt",className:"mt-1 flex w-full cursor-pointer items-center gap-2 rounded-lg border border-gray-300 bg-white p-2 text-gray-500 shadow-sm hover:bg-gray-50",children:[e.jsx(Ke,{size:18}),e.jsx("span",{children:j?j.name:"Selecciona un archivo..."})]}),e.jsx("input",{id:"payment-receipt",type:"file",accept:"image/*,.pdf",onChange:h=>w(h.target.files?h.target.files[0]:null),className:"hidden"})]}),e.jsxs("div",{className:"pt-4 flex flex-col sm:flex-row gap-3",children:[e.jsx("button",{type:"button",onClick:l,className:"w-full ui-btn-secondary py-3",children:"Cancelar"}),e.jsx("button",{type:"submit",disabled:N,className:"w-full ui-btn-success py-3 disabled:opacity-60",children:N?"Finalizando...":"Confirmar pago"})]})]})})},ct=a=>a??"",ot=a=>!a||a.length===0?[]:a.slice().sort(),W=(a=[])=>{const l=new Map;for(const r of a)l.set(r.id,{quantite:r.quantite,commentaire:ct(r.commentaire),excludedIngredients:ot(r.excluded_ingredients)});return{size:a.length,itemsById:l}},me=(a,l)=>{if(a===l)return!0;if(a.size!==l.size)return!1;for(const[r,u]of a.itemsById){const o=l.itemsById.get(r);if(!o||u.quantite!==o.quantite||u.commentaire!==o.commentaire||u.excludedIngredients.length!==o.excludedIngredients.length)return!1;for(let m=0;m<u.excludedIngredients.length;m+=1)if(u.excludedIngredients[m]!==o.excludedIngredients[m])return!1}return!0},dt=({filteredProducts:a,quantities:l,onAdd:r,activeCategoryId:u,categories:o,onSelectCategory:m,isProductAvailable:j,handleProductPointerDown:w,handleProductKeyDown:N})=>e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"p-4 border-b",children:e.jsxs("div",{className:"flex space-x-2 mt-4 overflow-x-auto pb-2",children:[e.jsx("button",{onClick:()=>m("all"),className:`px-4 py-2 rounded-full font-semibold whitespace-nowrap ${u==="all"?"bg-brand-primary text-brand-secondary":"bg-gray-200 text-gray-700"}`,children:"Tous"}),o.map(c=>e.jsx("button",{onClick:()=>m(c.id),className:`px-4 py-2 rounded-full font-semibold whitespace-nowrap ${u===c.id?"bg-brand-primary text-brand-secondary":"bg-gray-200 text-gray-700"}`,children:c.nom},c.id))]})}),e.jsx("div",{className:"p-4 grid grid-cols-1 gap-4 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 overflow-y-auto",children:a.map(c=>{const C=!j(c),h=l[c.id]||0,_=()=>r(c),B=w(c),x=N(c);return e.jsxs("button",{type:"button",onClick:_,onPointerDown:B,onKeyDown:x,className:`border rounded-lg p-2 flex flex-col items-center justify-between text-center cursor-pointer hover:shadow-lg transition-all relative focus:outline-none focus:ring-2 focus:ring-brand-primary focus:ring-offset-2 focus:ring-offset-gray-900 ${C?"border-yellow-500 border-2":""}`,children:[h>0&&e.jsx("div",{className:"absolute top-1 left-1 bg-brand-accent text-white rounded-full h-5 w-5 flex items-center justify-center text-xs font-bold",children:h}),C&&e.jsx("div",{className:"absolute top-1 right-1 bg-yellow-500 text-white rounded-full p-1",title:"Stock bas",children:e.jsx(Qe,{size:16})}),e.jsx("img",{src:c.image,alt:c.nom_produit,className:"w-24 h-24 object-cover rounded-md mb-2"}),e.jsx("p",{className:"font-semibold text-sm text-gray-800",children:c.nom_produit}),e.jsx("p",{className:"text-xs text-gray-600 px-1 h-10 overflow-hidden flex-grow",children:c.description}),e.jsx("p",{className:"font-bold text-brand-primary mt-1",children:E(c.prix_vente)})]},c.id)})})]}),ut=s.memo(dt),mt=({categorizedItems:a,total:l,onQuantityChange:r,onCommentChange:u,onPersistComment:o,onStartEditingComment:m,onSendToKitchen:j,onServeOrder:w,onOpenPayment:N,isSending:c,hasPending:C,orderStatus:h,editingCommentId:_})=>{const B=a.pending.length+a.sent.length;return e.jsxs("div",{className:"ui-card flex flex-col",children:[e.jsx("div",{className:"p-4 border-b",children:e.jsx("h2",{className:"text-2xl font-semibold text-brand-secondary",children:"Commande"})}),e.jsx("div",{className:"flex-1 p-4 space-y-3 overflow-y-auto",children:B===0?e.jsx("p",{className:"text-gray-500",children:"La commande est vide."}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-lg font-semibold text-brand-secondary",children:"Articles à envoyer"}),e.jsx("span",{className:"text-sm text-gray-500",children:a.pending.length})]}),a.pending.length===0?e.jsx("p",{className:"text-sm text-gray-500",children:"Aucun article en attente."}):a.pending.map(({item:x,index:T})=>e.jsxs("div",{className:"p-3 rounded-lg bg-yellow-100",children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("p",{className:"font-bold text-gray-900 flex-1",children:[x.quantite,"x ",x.nom_produit]}),e.jsx("p",{className:"font-bold text-gray-900",children:E(x.quantite*x.prix_unitaire)})]}),e.jsxs("div",{className:"flex justify-between items-center mt-2",children:[e.jsxs("p",{className:"text-sm text-gray-700",children:[E(x.prix_unitaire)," /u"]}),e.jsxs("div",{className:"flex items-center space-x-2 text-gray-800",children:[e.jsx("button",{onClick:()=>r(T,-1),className:"p-1",children:e.jsx(et,{size:20})}),e.jsx("span",{className:"font-bold w-6 text-center",children:x.quantite}),e.jsx("button",{onClick:()=>r(T,1),className:"p-1",children:e.jsx(Ge,{size:20})})]})]}),_===x.id||x.commentaire?e.jsx("input",{type:"text",placeholder:"Ajouter un commentaire...",value:x.commentaire??"",onChange:Y=>u(T,Y.target.value),onBlur:()=>o(T),autoFocus:_===x.id,className:"mt-2 ui-input text-sm"}):e.jsxs("button",{onClick:()=>m(x.id),className:"mt-2 text-xs text-blue-600 hover:underline flex items-center gap-1",children:[e.jsx(nt,{size:12})," Ajouter un commentaire"]})]},x.id))]}),a.sent.length>0&&e.jsxs("div",{className:"space-y-3 pt-6 border-t border-gray-700",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-lg font-semibold text-brand-secondary",children:"Envoyés en cuisine"}),e.jsx("span",{className:"text-sm text-gray-500",children:a.sent.length})]}),a.sent.map(({item:x})=>e.jsxs("div",{className:"p-3 rounded-lg bg-green-100",children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("p",{className:"font-bold text-gray-900 flex-1",children:[x.quantite,"x ",x.nom_produit]}),e.jsx("p",{className:"font-bold text-gray-900",children:E(x.quantite*x.prix_unitaire)})]}),e.jsxs("p",{className:"text-sm text-gray-700 mt-2",children:[E(x.prix_unitaire)," /u"]}),x.commentaire&&e.jsxs("p",{className:"mt-2 text-sm italic text-gray-600 pl-2",children:['"',x.commentaire,'"']})]},x.id))]})]})}),e.jsxs("div",{className:"p-4 border-t space-y-4",children:[e.jsxs("div",{className:"flex justify-between text-2xl font-semibold text-brand-secondary",children:[e.jsx("span",{children:"Total"}),e.jsx("span",{children:E(l)})]}),h==="listo"&&e.jsxs("button",{onClick:w,className:"w-full ui-btn-info justify-center py-3",children:[e.jsx(Xe,{size:20}),e.jsx("span",{children:"Entregada"})]}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsxs("button",{onClick:j,disabled:c||!C,className:"flex-1 ui-btn-accent justify-center py-3 disabled:opacity-60",children:[e.jsx(it,{size:20}),e.jsx("span",{children:c?"Synchronisation…":"Envoyer en Cuisine"})]}),e.jsxs("button",{onClick:N,disabled:h!=="servido",className:"flex-1 ui-btn-success justify-center py-3 disabled:opacity-60",children:[e.jsx(Je,{size:20}),e.jsx("span",{children:"Finaliser"})]})]})]})]})},ft=({isOpen:a,product:l,onClose:r,onSave:u})=>{const[o,m]=s.useState(1),[j,w]=s.useState("");if(s.useEffect(()=>{a&&(m(1),w(""))},[a,l==null?void 0:l.id]),!l)return null;const N=()=>{m(h=>Math.max(1,h-1))},c=()=>{m(h=>h+1)},C=()=>{u({quantity:o,comment:j})};return e.jsx(ie,{isOpen:a,onClose:r,title:l.nom_produit,children:e.jsxs("div",{className:"space-y-4",children:[e.jsx("img",{src:l.image,alt:l.nom_produit,className:"w-full h-48 object-cover rounded-lg"}),l.description&&e.jsx("p",{className:"text-gray-200 text-sm",children:l.description}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-200",children:"Commentaire"}),e.jsx("textarea",{value:j,onChange:h=>w(h.target.value),rows:2,className:"mt-1 block w-full rounded-md border border-gray-600 bg-gray-900/60 py-2 px-3 text-sm text-gray-100 focus:border-brand-primary focus:outline-none focus:ring-2 focus:ring-brand-primary",placeholder:"Allergies, instructions spécifiques…"})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("button",{type:"button",onClick:N,className:"p-2 rounded-full bg-gray-800 text-gray-100 hover:bg-gray-700","aria-label":"Diminuer la quantité",children:e.jsx(rt,{size:18})}),e.jsx("span",{className:"w-8 text-center text-lg font-bold text-gray-100",children:o}),e.jsx("button",{type:"button",onClick:c,className:"p-2 rounded-full bg-gray-800 text-gray-100 hover:bg-gray-700","aria-label":"Augmenter la quantité",children:e.jsx(He,{size:18})})]}),e.jsxs("button",{type:"button",onClick:C,className:"rounded-lg bg-brand-primary py-2 px-6 font-semibold text-brand-secondary transition hover:bg-yellow-400",children:["Ajouter (",E(l.prix_vente*o),")"]})]})]})})},ae=a=>!!a&&/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(a),O=a=>JSON.parse(JSON.stringify(a)),fe=(()=>{let a=0;return()=>typeof crypto<"u"&&typeof crypto.randomUUID=="function"?`tmp-${crypto.randomUUID()}`:(a+=1,`tmp-${Date.now()}-${a}`)})(),xe=a=>(a??"").trim(),xt=(a=[],l=[])=>{if(a.length!==l.length)return!1;const r=[...a].sort(),u=[...l].sort();return r.every((o,m)=>o===u[m])},ht=(a,l,r,u,o=[])=>{const m=xe(r.comment),j=Number.isFinite(r.quantity)?Math.max(1,Math.floor(r.quantity)):1;if(!m){const N=a.findIndex(c=>c.produitRef===l.id&&c.estado==="en_attente"&&xe(c.commentaire)===""&&xt(c.excluded_ingredients??[],o));if(N>-1)return a.map((c,C)=>C===N?{...c,quantite:c.quantite+j}:c)}const w={id:u(),produitRef:l.id,nom_produit:l.nom_produit,prix_unitaire:l.prix_vente,quantite:j,excluded_ingredients:[...o],commentaire:m,estado:"en_attente"};return[...a,w]},he=W([]),vt=()=>{const{tableId:a}=$e(),l=Be(),[r,u]=s.useState(null),[o,m]=s.useState(null),[j,w]=s.useState([]),[N,c]=s.useState([]),[C,h]=s.useState([]),[_,B]=s.useState("all"),[x,T]=s.useState(!0),[Y,le]=s.useState(!1),[pe,L]=s.useState(!1),[ge,X]=s.useState(null),[ye,ce]=s.useState(!1),[K,Z]=s.useState(null),p=s.useRef(r),q=s.useRef(o),z=s.useRef(null),M=s.useRef(null),D=s.useRef(null),ee=s.useRef(Promise.resolve()),P=s.useRef(null),A=s.useRef(null),b=s.useCallback((t,n,i)=>{if(!n||n.length===0)return t.current=null,he;const d=i??W(n);return t.current={source:n,snapshot:d},d},[]),Q=s.useCallback((t,n)=>{if(!t||t.length===0)return n.current=null,he;const i=n.current;return i&&i.source===t?i.snapshot:b(n,t)},[b]);s.useEffect(()=>{p.current=r},[r]),s.useEffect(()=>{q.current=o},[o]);const F=s.useCallback(t=>{const n=p.current;if(!n)return!0;const i=t??q.current;if(!i)return!0;const d=Q(n.items,P),f=t?W(i.items):Q(i.items,A);return me(f,d)},[Q]),J=s.useCallback(()=>{const t=M.current;if(!t)return;const n=W(t.items);z.current=O(t);const i=p.current;if(i){const f=Q(i.items,P);if(me(f,n)){M.current=null;return}}M.current=null,p.current=t,u(t),b(P,t.items,n);const d=O(t);q.current=d,m(d),b(A,d.items)},[Q,b]),R=s.useCallback(async(t=!1)=>{if(a)try{if(t||T(!0),t){const g=await S.createOrGetOrderByTableId(a),U=O(g);if(z.current=U,F()){M.current=null,u(g),p.current=g,b(P,g.items);const y=O(g);q.current=y,m(y),b(A,y.items)}else{const y=q.current;y&&JSON.stringify(y)===JSON.stringify(g)?M.current=null:M.current=U}return}const[n,i,d,f]=await Promise.all([S.createOrGetOrderByTableId(a),S.getProducts(),S.getCategories(),S.getIngredients()]);z.current=O(n),u(n),p.current=n,b(P,n.items);const v=O(n);m(v),q.current=v,b(A,v.items),w(i),c(d),h(f),M.current=null}catch(n){console.error("Failed to load order data",n),l("/ventes")}finally{t||T(!1)}},[F,l,a,b]);s.useEffect(()=>{R();const t=setInterval(()=>R(!0),5e3);return()=>clearInterval(t)},[R]),s.useEffect(()=>{F()&&J()},[J,F,r,o]),s.useEffect(()=>{const t=S.notifications.subscribe("orders_updated",()=>R(!0));return()=>t()},[R]);const be=s.useMemo(()=>!F(),[F,r,o]),je=s.useMemo(()=>r?r.items.reduce((t,n)=>(n.estado!=="en_attente"||(t[n.produitRef]=(t[n.produitRef]||0)+n.quantite),t),{}):{},[r]),ve=s.useMemo(()=>_==="all"?j:j.filter(t=>t.categoria_id===_),[_,j]),Ne=s.useCallback(t=>{if(!t.recipe||t.recipe.length===0)return!0;for(const n of t.recipe){const i=C.find(d=>d.id===n.ingredient_id);if(!i||i.stock_actuel<=i.stock_minimum)return!1}return!0},[C]);s.useEffect(()=>()=>{D.current!==null&&(window.clearTimeout(D.current),D.current=null)},[]);const k=s.useCallback(async(t,n)=>{const i=p.current;if(!i)return;const d=y=>typeof t=="function"?t(y):t,v=(n!=null&&n.isLocalUpdate?i.items:(n==null?void 0:n.removalSourceItems)??i.items).map(y=>({...y})),g=d(v),U={...i,items:g,total:g.reduce((y,V)=>y+V.quantite*V.prix_unitaire,0)};if(u(U),p.current=U,b(P,U.items),n!=null&&n.isLocalUpdate)return;const se=async()=>{try{let y=M.current??z.current??null;if(!y){const I=await S.getOrderById(i.id);I?(y=I,z.current=O(I)):y=i}if(!y)return;const V=y.items.map(I=>({...I})),Re=(n==null?void 0:n.removalSourceItems)??i.items,ue=d(V),Ae=Re.filter(I=>ae(I.id)&&!ue.some(Ue=>Ue.id===I.id)).map(I=>I.id),G=await S.updateOrder(i.id,{items:ue,removedItemIds:Ae},{includeNotifications:!1});u(G),p.current=G,b(P,G.items);const re=O(G);m(re),q.current=re,b(A,re.items),z.current=O(G),S.getIngredients().then(h).catch(I=>{console.error("Failed to refresh ingredients",I)}),J()}catch(y){console.error("Failed to update order:",y),alert("Une erreur est survenue lors de la mise à jour de la commande."),R(!0)}};ee.current=ee.current.then(se,se),await ee.current},[J,R,b]),oe=s.useCallback((t=100)=>{D.current!==null&&window.clearTimeout(D.current);const n=t>0?t:1;D.current=window.setTimeout(()=>{if(D.current=null,!p.current)return;const i=p.current.items.map(f=>({...f})),d=z.current?z.current.items.map(f=>({...f})):i.map(f=>({...f}));k(i,{removalSourceItems:d})},n)},[k]),H=s.useCallback(t=>{p.current&&(k(t,{isLocalUpdate:!0}),oe())},[oe,k]),te=s.useCallback(t=>{Z(t)},[]),Ce=s.useCallback(()=>{Z(null)},[]),Se=s.useCallback(t=>{K&&(H(n=>ht(n,K,t,fe)),Z(null))},[H,K]),we=s.useCallback((t,n)=>{H(i=>{if(!i[t])return i;const d=i.map(v=>({...v})),f=d[t].quantite+n;return f<=0?d.splice(t,1):d[t].quantite=f,d})},[H]),Ie=s.useCallback((t,n)=>{k(i=>{if(!i[t])return i;const d=i.map(v=>({...v})),f=d[t];if(f.quantite>1&&!f.commentaire&&n){f.quantite-=1;const v={...f,id:fe(),quantite:1,commentaire:n};d.push(v),X(v.id)}else f.commentaire=n;return d},{isLocalUpdate:!0})},[k]),ke=s.useCallback(t=>{p.current&&(k(p.current.items.map(n=>({...n}))),X(null))},[k]),Oe=s.useCallback(async()=>{if(p.current){ce(!0);try{let t=p.current;for(;t&&t.items.some(g=>g.estado==="en_attente"&&!ae(g.id));)await k(t.items.map(g=>({...g}))),t=p.current;if(t=p.current,!t)return;const n=t.items.filter(g=>g.estado==="en_attente");if(n.length===0)return;if(n.filter(g=>!ae(g.id)).length>0){console.warn("Des articles non persistés subsistent après synchronisation, envoi annulé.");return}const d=n.map(g=>g.id),f=await S.sendOrderToKitchen(t.id,d);u(f),p.current=f,b(P,f.items);const v=O(f);m(v),q.current=v,b(A,v.items),l("/ventes")}catch(t){console.error("Failed to send order to kitchen",t),alert("Erreur lors de l'envoi en cuisine.")}finally{ce(!1)}}},[l,k,b]),_e=s.useCallback(async()=>{if(r)try{const t=await S.markOrderAsServed(r.id);u(t),p.current=t,b(P,t.items)}catch(t){console.error("Failed to mark order as served",t)}},[r,b]),Pe=async(t,n)=>{if(r)try{let i=r.payment_receipt_url??void 0;n&&(i=await Le(n,{orderId:r.id})),await S.finalizeOrder(r.id,t,i),l("/ventes")}catch(i){console.error("Failed to finalize order",i),alert("Erreur lors de la finalisation ou du téléversement du justificatif.")}},qe=()=>{if(r&&r.estado_cocina==="no_enviado"&&r.items.length>0){L(!0);return}be?L(!0):l("/ventes")},ze=async()=>{try{r&&r.estado_cocina==="no_enviado"?await S.cancelUnsentTableOrder(r.id):o&&!F(o)&&await k(o.items)}catch(t){console.error("Failed to cancel unsent order before exiting",t)}finally{L(!1),l("/ventes")}},de=(r==null?void 0:r.items)??[],ne=s.useMemo(()=>de.reduce((t,n,i)=>(n.estado==="en_attente"?t.pending.push({item:n,index:i}):t.sent.push({item:n,index:i}),t),{pending:[],sent:[]}),[de]),Me=s.useCallback(t=>n=>{n.preventDefault(),n.currentTarget.focus()},[]),Ee=s.useCallback(t=>n=>{(n.key==="Enter"||n.key===" ")&&(n.preventDefault(),te(t))},[te]),Te=s.useCallback(()=>{le(!0)},[]),De=s.useCallback(t=>{X(t)},[]),Fe=s.useMemo(()=>ne.pending.length>0,[ne]);return x?e.jsx("div",{className:"text-center p-10 text-gray-800",children:"Chargement de la commande..."}):r?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6 min-h-[calc(100vh-12rem)] lg:h-[calc(100vh-10rem)]",children:[e.jsxs("div",{className:"lg:col-span-2 ui-card flex flex-col",children:[e.jsx("div",{className:"p-4",children:e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-4",children:[e.jsxs("button",{onClick:qe,className:"ui-btn-dark",title:"Retour au plan de salle",children:[e.jsx(We,{size:20}),e.jsx("span",{children:"Retour plan de salle"})]}),e.jsxs("h2",{className:"text-2xl font-semibold text-gray-900",children:["Table ",r.table_nom]})]})}),e.jsx(ut,{filteredProducts:ve,quantities:je,onAdd:te,activeCategoryId:_,categories:N,onSelectCategory:B,isProductAvailable:Ne,handleProductPointerDown:Me,handleProductKeyDown:Ee})]}),e.jsx(mt,{categorizedItems:ne,total:r.total,onQuantityChange:we,onCommentChange:Ie,onPersistComment:ke,onStartEditingComment:De,onSendToKitchen:Oe,onServeOrder:_e,onOpenPayment:Te,isSending:ye,hasPending:Fe,orderStatus:r.estado_cocina,editingCommentId:ge})]}),e.jsx(ft,{isOpen:K!==null,product:K,onClose:Ce,onSave:Se}),e.jsx(lt,{isOpen:Y,onClose:()=>le(!1),order:r,onFinalize:Pe}),e.jsxs(ie,{isOpen:pe,onClose:()=>L(!1),title:"Quitter sans envoyer ?",children:[e.jsx("p",{className:"text-gray-700",children:"Vous avez des articles non envoyés en cuisine. Si vous quittez, ils seront annulés. Voulez-vous continuer ?"}),e.jsxs("div",{className:"flex justify-end gap-4 mt-6",children:[e.jsx("button",{onClick:()=>L(!1),className:"ui-btn-secondary",children:"Non, rester"}),e.jsx("button",{onClick:ze,className:"ui-btn-danger",children:"Oui, quitter"})]})]})]}):e.jsx("div",{className:"text-center p-10 text-red-500",children:"Commande non trouvée."})};export{vt as default,ht as mergeProductIntoPendingItems};
